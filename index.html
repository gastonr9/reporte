<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>REPORTE COCINA</title>
    <style>
      h1 {
        text-align: center;
        font-size: 30px;
        color: #333;
      }
      body {
        font-family: Arial, sans-serif;
        font-size: 25px;
        padding: 20px;
        background: #f0f0f0;
      }
      table {
        border-collapse: collapse;
        margin: auto;
        width: -webkit-fill-available;
      }
      td {
        border: 1px solid #444;
        padding: 10px;
        min-width: 80px;
        text-align: center;
        font-weight: bold;
      }
    </style>
  </head>
  <body>
    <h1 id="ultima-actualizacion">√öltima actualizaci√≥n: ---</h1>

    <div id="table-container">Cargando tabla...</div>
    <audio
      id="alertaAudio"
      src="/message-alert-190042.mp3"
      preload="auto"
    ></audio>

    <script>
      // üîÑ Funci√≥n para actualizar la celda X21 a "false"
      async function actualizarX21() {
        const urlDesmarcar =
          "https://script.google.com/macros/s/AKfycbwrM1VM-6g74z1C8O2HivV1dkDI988G4GRzbvkQP1FMA9RWmVivPKCmJlHT0k4tMi-4/exec"; // üîÅ Pega tu URL

        const params = new URLSearchParams({ accion: "desmarcar" });

        try {
          const res = await fetch(urlDesmarcar, {
            method: "POST",
            body: params,
          });
          const texto = await res.text();
          console.log("‚úÖ Estado cambiado a false:", texto);
        } catch (error) {
          console.error("‚ùå Error al desmarcar ejecuci√≥n:", error);
        }
      }
      const JSON_URL =
        "https://script.google.com/macros/s/AKfycby1kZ8ITZVwhsaHuw6hw1u0todLzX4gFAQY762P50refAjJx5lVPUk9nq-Chua6yBOl/exec";

      let ultimoJSONHash = "";

      function hashJSON(json) {
        return JSON.stringify(json);
      }

      async function dibujarTabla() {
        try {
          const res = await fetch(JSON_URL);
          const data = await res.json();
          ultimoJSONHash = hashJSON(data); // Guardar nueva versi√≥n

          const maxRow = Math.max(...data.map((c) => c.row));
          const maxCol = Math.max(...data.map((c) => c.col));
          const matrix = Array.from({ length: maxRow }, () =>
            Array.from({ length: maxCol }, () => null)
          );

          data.forEach((cell) => {
            matrix[cell.row - 1][cell.col - 1] = cell;
          });

          const table = document.createElement("table");

          for (let i = 0; i < matrix.length; i++) {
            const tr = document.createElement("tr");
            for (let j = 0; j < matrix[i].length; j++) {
              const cell = matrix[i][j];
              if (!cell) continue;

              const td = document.createElement("td");

              td.textContent = cell.value || "";
              td.style.backgroundColor = cell.background || "white";
              td.style.color = cell.fontColor || "#000";
              if (cell.bold) td.style.fontWeight = "bold";
              if (cell.italic) td.style.fontStyle = "italic";

              if (cell.rowspan > 1) td.rowSpan = cell.rowspan;
              if (cell.colspan > 1) td.colSpan = cell.colspan;

              tr.appendChild(td);

              for (let r = 0; r < (cell.rowspan || 1); r++) {
                for (let c = 0; c < (cell.colspan || 1); c++) {
                  if (r === 0 && c === 0) continue;
                  if (matrix[i + r] && matrix[i + r][j + c]) {
                    matrix[i + r][j + c] = null;
                  }
                }
              }
            }
            table.appendChild(tr);
          }

          document.getElementById("table-container").innerHTML = "";
          document.getElementById("table-container").appendChild(table);
        } catch (error) {
          console.error("‚ùå Error al dibujar tabla:", error);
        }
      }

      // üîç Verifica si el valor es "true"
      async function chequearCambio() {
        try {
          const res = await fetch(
            "https://script.google.com/macros/s/AKfycbwrM1VM-6g74z1C8O2HivV1dkDI988G4GRzbvkQP1FMA9RWmVivPKCmJlHT0k4tMi-4/exec"
          );
          const texto = await res.text();
          const valor = texto.trim().toLowerCase();

          if (valor === "true") {
            console.log("üö® Valor 'true' detectado. Ejecutando acciones...");
            document.getElementById("alertaAudio").play();

            dibujarTabla();
            await actualizarX21();
          }
        } catch (error) {
          console.error("‚ùå Error al verificar el estado:", error);
        }
      }

      async function hora() {
        const res = await fetch(JSON_URL);
        const nuevoJSON = await res.json();
        const nuevoHash = hashJSON(nuevoJSON);
        const ahora = new Date();
        const horaFormateada = ahora.toLocaleTimeString("es-ES", {
          hour: "2-digit",
          minute: "2-digit",
          second: "2-digit",
        });
        document.getElementById("ultima-actualizacion").textContent =
          "√öltima actualizaci√≥n: " + horaFormateada;
        ultimoJSONHash = nuevoHash;
      }

      // üîÅ Chequeo autom√°tico cada 10 segundos
      async function verificarCambiosEnJSON() {
        try {
          const res = await fetch(JSON_URL);
          const nuevoJSON = await res.json();
          const nuevoHash = hashJSON(nuevoJSON);

          if (nuevoHash !== ultimoJSONHash) {
            console.log("üîÑ Cambios detectados en JSON. Redibujando tabla.");
            hora();

            dibujarTabla();
          }
        } catch (err) {
          console.error("‚ùå Error al verificar cambios JSON:", err);
        }
      }
      hora(); // Actualizar hora al cargar
      dibujarTabla(); // primer carga
      setInterval(chequearCambio, 10000);
      setInterval(verificarCambiosEnJSON, 10000); // cada 10s
    </script>
  </body>
</html>
