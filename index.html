<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Google Sheets con Colores y Celdas Combinadas</title>
    <style>
      body {
        font-family: Arial, Helvetica, sans-serif;
        background-color: #f5f5f5;
        padding: 20px;
        font-weight: 700;
      }
      h1 {
        text-align: center;
        color: #4caf50;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 26px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        min-width: max-content;
      }
      th,
      td {
        border: 2px solid #000;
        padding-inline: 20px;
        text-align: center;
      }
      th {
        background-color: #4caf50;
        color: white;
      }
    </style>
  </head>
  <body>
    <h1>Google Sheets en Tiempo Real</h1>
    <div id="table-container">Cargando...</div>

    <script>
      const JSON_URL =
        "https://opensheet.elk.sh/18Cf-eNt4IdN8wB_zE43Mjc6SsKQSOt8ExMK-2NkMBBo/2";
      const HTML_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlbYlX3y3ym8VeKgl9INPxLa_jEcbmud4d6aQJ9zOEFPU6Mrd3lZcObc-ojsRi8uSPmVxKjH8Nliru/pubhtml?gid=1720136139&single=true";

      async function loadData() {
        try {
          const [jsonData, htmlText] = await Promise.all([
            fetch(`${JSON_URL}?_=${Date.now()}`).then((r) => r.json()),
            fetch(`${HTML_URL}&_=${Date.now()}`).then((r) => r.text()),
          ]);

          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlText, "text/html");

          const styleText = doc.querySelector("style")?.textContent || "";
          const classColorMap = {};
          const colorRegex = /\.s\d+\s*{[^}]*}/gi;

          let match;
          while ((match = colorRegex.exec(styleText)) !== null) {
            const className = match[0].match(/\.s\d+/)?.[0]?.substring(1);
            const bg = match[0].match(/background-color:\s*([^;]+);/i)?.[1];
            const color = match[0].match(/color:\s*([^;]+);/i)?.[1];
            if (className) {
              classColorMap[className] = {
                background: bg || "",
                color: color || "",
              };
            }
          }

          const htmlTableRows = Array.from(
            doc.querySelectorAll("table tr")
          ).filter((row) => row.querySelectorAll("td, th").length > 0);

          const headers = Object.keys(jsonData[0]);
          let html = "<table><thead><tr>";
          headers.forEach((header) => {
            html += `<th>${header}</th>`;
          });
          html += "</tr></thead><tbody>";

          const spanMap = {}; // mapa de celdas ocupadas por rowspan/colspan

          jsonData.forEach((row, rowIndex) => {
            html += "<tr>";
            headers.forEach((key, colIndex) => {
              while (spanMap[`${rowIndex},${colIndex}`]) {
                colIndex++;
              }

              const value = row[key] ?? "";
              const htmlRow = htmlTableRows[rowIndex + 1];
              const htmlCell =
                htmlRow?.querySelectorAll("td, th")[colIndex + 1];

              let bgColor = "";
              let color = "";
              let rowspan = "";
              let colspan = "";

              if (htmlCell) {
                const classNames = htmlCell.className.split(/\s+/);
                classNames.forEach((cls) => {
                  if (classColorMap[cls]) {
                    bgColor = classColorMap[cls].background;
                    color = classColorMap[cls].color;
                  }
                });

                rowspan = htmlCell.getAttribute("rowspan");
                colspan = htmlCell.getAttribute("colspan");

                const rs = parseInt(rowspan || 1);
                const cs = parseInt(colspan || 1);
                for (let r = 0; r < rs; r++) {
                  for (let c = 0; c < cs; c++) {
                    if (r !== 0 || c !== 0) {
                      spanMap[`${rowIndex + r},${colIndex + c}`] = true;
                    }
                  }
                }
              }

              const style = `${bgColor ? `background-color:${bgColor};` : ""}${
                color ? `color:${color};` : ""
              }`;
              const spanAttrs =
                (rowspan ? ` rowspan="${rowspan}"` : "") +
                (colspan ? ` colspan="${colspan}"` : "");
              html += `<td${spanAttrs} style="${style}">${value}</td>`;
            });
            html += "</tr>";
          });

          html += "</tbody></table>";
          document.getElementById("table-container").innerHTML = html;
        } catch (error) {
          console.error(error);
          document.getElementById("table-container").innerText =
            "Error al cargar los datos.";
        }
      }

      loadData();
      setInterval(loadData, 20000); // auto-refresh cada 20s
    </script>
  </body>
</html>
