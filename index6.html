<!DOCTYPE html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Tabla en Tiempo Real</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        background-color: #f5f5f5;
        padding: 20px;
        font-weight: 700;
      }
      h1 {
        text-align: center;
        color: #4caf50;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 22px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        min-width: max-content;
      }
      td {
        border: 1px solid #000;
        padding: 8px 0px;
        text-align: center;
      }
    </style>
  </head>
  <body>
    <div id="table-container">Cargando...</div>

    <script>
      const JSON_URL =
        "https://opensheet.elk.sh/18Cf-eNt4IdN8wB_zE43Mjc6SsKQSOt8ExMK-2NkMBBo/2";
      const HTML_URL =
        "https://docs.google.com/spreadsheets/d/e/2PACX-1vTlbYlX3y3ym8VeKgl9INPxLa_jEcbmud4d6aQJ9zOEFPU6Mrd3lZcObc-ojsRi8uSPmVxKjH8Nliru/pubhtml?gid=1720136139&single=true";

      // Inicializar JSON local desde almacenamiento si existe
      let jsonLocal = JSON.parse(localStorage.getItem("jsonLocal")) || [];

      async function fetchJsonRemote() {
        const res = await fetch(`${JSON_URL}?_=${Date.now()}`);
        return await res.json();
      }

      async function checkForUpdates() {
        try {
          const jsonRemote = await fetchJsonRemote();
          const oldString = JSON.stringify(jsonLocal);
          const newString = JSON.stringify(jsonRemote);

          if (oldString !== newString) {
            console.log("🔁 Cambio detectado en JSON remoto, actualizando...");
            jsonLocal = jsonRemote;
            localStorage.setItem("jsonLocal", JSON.stringify(jsonLocal));
            loadData(); // renderizar con nuevo json
          } else {
            console.log("✅ No hay cambios en JSON");
          }
        } catch (e) {
          console.error("Error verificando cambios en JSON:", e);
        }
      }

      async function loadData() {
        try {
          const htmlRes = await fetch(`${HTML_URL}&_=${Date.now()}`);
          const htmlText = await htmlRes.text();

          const parser = new DOMParser();
          const doc = parser.parseFromString(htmlText, "text/html");
          const styleText = doc.querySelector("style")?.textContent || "";
          const classColorMap = {};
          const colorRegex = /\.s\d+\s*{[^}]*}/gi;

          let match;
          while ((match = colorRegex.exec(styleText)) !== null) {
            const cls = match[0].match(/\.s\d+/)?.[0]?.substring(1);
            const bg = match[0].match(/background-color:\s*([^;]+);/i)?.[1];
            const color = match[0].match(/color:\s*([^;]+);/i)?.[1];
            if (cls) {
              classColorMap[cls] = {
                background: bg || "",
                color: color || "",
              };
            }
          }

          const originalTable = doc.querySelector("table");
          const rows = originalTable.querySelectorAll("tr");

          const lookup = {};
          jsonLocal.forEach((row) => {
            const key = row.PRODUCTO?.trim().toUpperCase();
            if (key) lookup[key] = row;
          });

          function replaceCellText(cellText, rowData) {
            const upper = cellText.trim().toUpperCase();
            if (!upper || !rowData) return cellText;
            if (upper in rowData) return rowData[upper];

            const keys = Object.keys(rowData);
            for (let k of keys) {
              if (cellText.trim().toLowerCase() === k.trim().toLowerCase()) {
                return rowData[k];
              }
            }
            return cellText;
          }

          let htmlOutput = "<table><tbody>";

          rows.forEach((row, rowIndex) => {
            if (rowIndex === 1) return;

            htmlOutput += "<tr>";
            const cells = row.querySelectorAll("td, th");
            const firstCellText =
              row.querySelector("td, th")?.textContent?.toUpperCase()?.trim() ||
              "";
            const rowData = lookup[firstCellText] || null;

            cells.forEach((cell, cellIndex) => {
              if (cellIndex === 0) return;

              const tag = cell.tagName.toLowerCase();
              const classList = cell.className.split(/\s+/);
              const styleParts = [];

              classList.forEach((cls) => {
                const styles = classColorMap[cls];
                if (styles?.background)
                  styleParts.push(`background-color:${styles.background}`);
                if (styles?.color && styles.color !== "transparent")
                  styleParts.push(`text-color:${styles.color}`);
              });

              const style =
                styleParts.length > 0 ? ` style="${styleParts.join(";")}"` : "";

              const spanAttrs = [];
              if (cell.hasAttribute("rowspan"))
                spanAttrs.push(`rowspan="${cell.getAttribute("rowspan")}"`);
              if (cell.hasAttribute("colspan"))
                spanAttrs.push(`colspan="${cell.getAttribute("colspan")}"`);

              let content = cell.textContent.trim();
              if (rowData) content = replaceCellText(content, rowData);

              htmlOutput += `<${tag} ${spanAttrs.join(
                " "
              )}${style}>${content}</${tag}>`;
            });

            htmlOutput += "</tr>";
          });

          htmlOutput += "</tbody></table>";
          document.getElementById("table-container").innerHTML = htmlOutput;
        } catch (err) {
          console.error("❌ Error al renderizar tabla:", err);
        }
      }

      // Ejecutar por primera vez
      if (!jsonLocal.length) {
        fetchJsonRemote().then((data) => {
          jsonLocal = data;
          localStorage.setItem("jsonLocal", JSON.stringify(jsonLocal));
          loadData();
        });
      } else {
        loadData(); // cargar desde cache
      }

      // Verifica cada 20s si el JSON ha cambiado
      setInterval(checkForUpdates, 20000);
    </script>
  </body>
</html>
